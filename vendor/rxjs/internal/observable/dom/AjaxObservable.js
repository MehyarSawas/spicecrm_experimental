"use strict";var __extends=this&&this.__extends||function(){var s=function(e,r){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(e,r)};return function(e,r){function t(){this.constructor=e}s(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}}();Object.defineProperty(exports,"__esModule",{value:!0});var root_1=require("../../util/root"),Observable_1=require("../../Observable"),Subscriber_1=require("../../Subscriber"),map_1=require("../../operators/map");function getCORSRequest(){if(root_1.root.XMLHttpRequest)return new root_1.root.XMLHttpRequest;if(root_1.root.XDomainRequest)return new root_1.root.XDomainRequest;throw new Error("CORS is not supported by your browser")}function getXMLHttpRequest(){if(root_1.root.XMLHttpRequest)return new root_1.root.XMLHttpRequest;var e=void 0;try{for(var r=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],t=0;t<3;t++)try{if(e=r[t],new root_1.root.ActiveXObject(e))break}catch(e){}return new root_1.root.ActiveXObject(e)}catch(e){throw new Error("XMLHttpRequest is not supported by your browser")}}function ajaxGet(e,r){return new AjaxObservable({method:"GET",url:e,headers:r=void 0===r?null:r})}function ajaxPost(e,r,t){return new AjaxObservable({method:"POST",url:e,body:r,headers:t})}function ajaxDelete(e,r){return new AjaxObservable({method:"DELETE",url:e,headers:r})}function ajaxPut(e,r,t){return new AjaxObservable({method:"PUT",url:e,body:r,headers:t})}function ajaxPatch(e,r,t){return new AjaxObservable({method:"PATCH",url:e,body:r,headers:t})}exports.ajaxGet=ajaxGet,exports.ajaxPost=ajaxPost,exports.ajaxDelete=ajaxDelete,exports.ajaxPut=ajaxPut,exports.ajaxPatch=ajaxPatch;var mapResponse=map_1.map(function(e,r){return e.response});function ajaxGetJSON(e,r){return mapResponse(new AjaxObservable({method:"GET",url:e,responseType:"json",headers:r}))}exports.ajaxGetJSON=ajaxGetJSON;var AjaxObservable=function(o){function r(e){var r=o.call(this)||this,t={async:!0,createXHR:function(){return(this.crossDomain?getCORSRequest:getXMLHttpRequest)()},crossDomain:!0,withCredentials:!1,headers:{},method:"GET",responseType:"json",timeout:0};if("string"==typeof e)t.url=e;else for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);return r.request=t,r}function e(e){return new r(e)}return __extends(r,o),r.prototype._subscribe=function(e){return new AjaxSubscriber(e,this.request)},r.create=(e.get=ajaxGet,e.post=ajaxPost,e.delete=ajaxDelete,e.put=ajaxPut,e.patch=ajaxPatch,e.getJSON=ajaxGetJSON,e),r}(Observable_1.Observable);exports.AjaxObservable=AjaxObservable;var AjaxSubscriber=function(s){function e(e,r){var t=s.call(this,e)||this;t.request=r,t.done=!1;e=r.headers=r.headers||{};return r.crossDomain||t.getHeader(e,"X-Requested-With")||(e["X-Requested-With"]="XMLHttpRequest"),t.getHeader(e,"Content-Type")||root_1.root.FormData&&r.body instanceof root_1.root.FormData||void 0===r.body||(e["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8"),r.body=t.serializeBody(r.body,t.getHeader(r.headers,"Content-Type")),t.send(),t}return __extends(e,s),e.prototype.next=function(e){this.done=!0;var r,t=this,s=t.xhr,o=t.request,t=t.destination;try{r=new AjaxResponse(e,s,o)}catch(e){return t.error(e)}t.next(r)},e.prototype.send=function(){var e=this.request,r=this.request,t=r.user,s=r.method,o=r.url,n=r.async,a=r.password,i=r.headers,r=r.body;try{var u=this.xhr=e.createXHR();this.setupEvents(u,e),t?u.open(s,o,n,t,a):u.open(s,o,n),n&&(u.timeout=e.timeout,u.responseType=e.responseType),"withCredentials"in u&&(u.withCredentials=!!e.withCredentials),this.setHeaders(u,i),r?u.send(r):u.send()}catch(e){this.error(e)}},e.prototype.serializeBody=function(r,e){if(!r||"string"==typeof r)return r;if(root_1.root.FormData&&r instanceof root_1.root.FormData)return r;var t;switch(!e||-1!==(t=e.indexOf(";"))&&(e=e.substring(0,t)),e){case"application/x-www-form-urlencoded":return Object.keys(r).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r[e])}).join("&");case"application/json":return JSON.stringify(r);default:return r}},e.prototype.setHeaders=function(e,r){for(var t in r)r.hasOwnProperty(t)&&e.setRequestHeader(t,r[t])},e.prototype.getHeader=function(e,r){for(var t in e)if(t.toLowerCase()===r.toLowerCase())return e[t]},e.prototype.setupEvents=function(e,r){var t,n,s=r.progressSubscriber;function a(e){var r,t=a.subscriber,s=a.progressSubscriber,o=a.request;s&&s.error(e);try{r=new exports.AjaxTimeoutError(this,o)}catch(e){r=e}t.error(r)}function o(e){}function i(r){var e=i.subscriber,t=i.progressSubscriber,s=i.request;if(4===this.readyState){var o=1223===this.status?204:this.status,n="text"===this.responseType?this.response||this.responseText:this.response;if((o=0===o?n?200:0:o)<400)t&&t.complete(),e.next(r),e.complete();else{t&&t.error(r);r=void 0;try{r=new exports.AjaxError("ajax error "+o,this,s)}catch(e){r=e}e.error(r)}}}(e.ontimeout=a).request=r,a.subscriber=this,a.progressSubscriber=s,e.upload&&"withCredentials"in e&&(s&&(t=function(e){t.progressSubscriber.next(e)},root_1.root.XDomainRequest?e.onprogress=t:e.upload.onprogress=t,t.progressSubscriber=s),n=function(e){var r,t=n.progressSubscriber,s=n.subscriber,o=n.request;t&&t.error(e);try{r=new exports.AjaxError("ajax error",this,o)}catch(e){r=e}s.error(r)},(e.onerror=n).request=r,n.subscriber=this,n.progressSubscriber=s),(e.onreadystatechange=o).subscriber=this,o.progressSubscriber=s,o.request=r,(e.onload=i).subscriber=this,i.progressSubscriber=s,i.request=r},e.prototype.unsubscribe=function(){var e=this.done,r=this.xhr;!e&&r&&4!==r.readyState&&"function"==typeof r.abort&&r.abort(),s.prototype.unsubscribe.call(this)},e}(Subscriber_1.Subscriber);exports.AjaxSubscriber=AjaxSubscriber;var AjaxResponse=function(e,r,t){this.originalEvent=e,this.xhr=r,this.request=t,this.status=r.status,this.responseType=r.responseType||t.responseType,this.response=parseXhrResponse(this.responseType,r)};exports.AjaxResponse=AjaxResponse;var AjaxErrorImpl=function(){function e(e,r,t){return Error.call(this),this.message=e,this.name="AjaxError",this.xhr=r,this.request=t,this.status=r.status,this.responseType=r.responseType||t.responseType,this.response=parseXhrResponse(this.responseType,r),this}return e.prototype=Object.create(Error.prototype),e}();function parseJson(e){return"response"in e?e.responseType?e.response:JSON.parse(e.response||e.responseText||"null"):JSON.parse(e.responseText||"null")}function parseXhrResponse(e,r){switch(e){case"json":return parseJson(r);case"xml":return r.responseXML;default:return"response"in r?r.response:r.responseText}}function AjaxTimeoutErrorImpl(e,r){return exports.AjaxError.call(this,"ajax timeout",e,r),this.name="AjaxTimeoutError",this}exports.AjaxError=AjaxErrorImpl,exports.AjaxTimeoutError=AjaxTimeoutErrorImpl;