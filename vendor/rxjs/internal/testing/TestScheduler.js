"use strict";var __extends=this&&this.__extends||function(){var i=function(e,r){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(e,r)};return function(e,r){function t(){this.constructor=e}i(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=require("../Observable"),Notification_1=require("../Notification"),ColdObservable_1=require("./ColdObservable"),HotObservable_1=require("./HotObservable"),SubscriptionLog_1=require("./SubscriptionLog"),VirtualTimeScheduler_1=require("../scheduler/VirtualTimeScheduler"),AsyncScheduler_1=require("../scheduler/AsyncScheduler"),defaultMaxFrame=750,TestScheduler=function(t){function c(e){var r=t.call(this,VirtualTimeScheduler_1.VirtualAction,defaultMaxFrame)||this;return r.assertDeepEqual=e,r.hotObservables=[],r.coldObservables=[],r.flushTests=[],r.runMode=!1,r}return __extends(c,t),c.prototype.createTime=function(e){e=e.indexOf("|");if(-1===e)throw new Error('marble diagram for time should have a completion marker "|"');return e*c.frameTimeFactor},c.prototype.createColdObservable=function(e,r,t){if(-1!==e.indexOf("^"))throw new Error('cold observable cannot have subscription offset "^"');if(-1!==e.indexOf("!"))throw new Error('cold observable cannot have unsubscription marker "!"');t=c.parseMarbles(e,r,t,void 0,this.runMode),t=new ColdObservable_1.ColdObservable(t,this);return this.coldObservables.push(t),t},c.prototype.createHotObservable=function(e,r,t){if(-1!==e.indexOf("!"))throw new Error('hot observable cannot have unsubscription marker "!"');t=c.parseMarbles(e,r,t,void 0,this.runMode),t=new HotObservable_1.HotObservable(t,this);return this.hotObservables.push(t),t},c.prototype.materializeInnerObservable=function(e,r){var t=this,i=[];return e.subscribe(function(e){i.push({frame:t.frame-r,notification:Notification_1.Notification.createNext(e)})},function(e){i.push({frame:t.frame-r,notification:Notification_1.Notification.createError(e)})},function(){i.push({frame:t.frame-r,notification:Notification_1.Notification.createComplete()})}),i},c.prototype.expectObservable=function(e,r){var t,i=this,a=[],o={actual:a,ready:!1},s=c.parseMarblesAsSubscriptions(r=void 0===r?null:r,this.runMode),r=s.subscribedFrame===Number.POSITIVE_INFINITY?0:s.subscribedFrame,s=s.unsubscribedFrame;this.schedule(function(){t=e.subscribe(function(e){var r=e;e instanceof Observable_1.Observable&&(r=i.materializeInnerObservable(r,i.frame)),a.push({frame:i.frame,notification:Notification_1.Notification.createNext(r)})},function(e){a.push({frame:i.frame,notification:Notification_1.Notification.createError(e)})},function(){a.push({frame:i.frame,notification:Notification_1.Notification.createComplete()})})},r),s!==Number.POSITIVE_INFINITY&&this.schedule(function(){return t.unsubscribe()},s),this.flushTests.push(o);var n=this.runMode;return{toBe:function(e,r,t){o.ready=!0,o.expected=c.parseMarbles(e,r,t,!0,n)}}},c.prototype.expectSubscriptions=function(e){var r={actual:e,ready:!1};this.flushTests.push(r);var t=this.runMode;return{toBe:function(e){e="string"==typeof e?[e]:e;r.ready=!0,r.expected=e.map(function(e){return c.parseMarblesAsSubscriptions(e,t)})}}},c.prototype.flush=function(){for(var r=this,e=this.hotObservables;0<e.length;)e.shift().setup();t.prototype.flush.call(this),this.flushTests=this.flushTests.filter(function(e){return!e.ready||(r.assertDeepEqual(e.actual,e.expected),!1)})},c.parseMarblesAsSubscriptions=function(n,c){var u=this;if(void 0===c&&(c=!1),"string"!=typeof n)return new SubscriptionLog_1.SubscriptionLog(Number.POSITIVE_INFINITY);for(var b,e=n.length,f=-1,l=Number.POSITIVE_INFINITY,h=Number.POSITIVE_INFINITY,p=0,r=function(e){function r(e){t+=e*u.frameTimeFactor}var t=p,i=n[e];switch(i){case" ":c||r(1);break;case"-":r(1);break;case"(":f=p,r(1);break;case")":f=-1,r(1);break;case"^":if(l!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");l=-1<f?f:p,r(1);break;case"!":if(h!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");h=-1<f?f:p;break;default:if(c&&i.match(/^[0-9]$/)&&(0===e||" "===n[e-1])){var a=n.slice(e).match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(a){e+=a[0].length-1;var o=parseFloat(a[1]),s=void 0;switch(a[2]){case"ms":s=o;break;case"s":s=1e3*o;break;case"m":s=1e3*o*60}r(s/d.frameTimeFactor);break}}throw new Error("there can only be '^' and '!' markers in a subscription marble diagram. Found instead '"+i+"'.")}p=t,b=e},d=this,t=0;t<e;t++)r(t),t=b;return h<0?new SubscriptionLog_1.SubscriptionLog(l):new SubscriptionLog_1.SubscriptionLog(l,h)},c.parseMarbles=function(c,r,u,t,b){var f=this;if(void 0===t&&(t=!1),void 0===b&&(b=!1),-1!==c.indexOf("!"))throw new Error('conventional marble diagrams cannot have the unsubscription marker "!"');for(var l,e=c.length,h=[],i=(b?c.replace(/^[ ]+/,""):c).indexOf("^"),p=-1===i?0:i*-this.frameTimeFactor,d="object"!=typeof r?function(e){return e}:function(e){return t&&r[e]instanceof ColdObservable_1.ColdObservable?r[e].messages:r[e]},m=-1,a=function(e){function r(e){t+=e*f.frameTimeFactor}var t=p,i=void 0,a=c[e];switch(a){case" ":b||r(1);break;case"-":r(1);break;case"(":m=p,r(1);break;case")":m=-1,r(1);break;case"|":i=Notification_1.Notification.createComplete(),r(1);break;case"^":r(1);break;case"#":i=Notification_1.Notification.createError(u||"error"),r(1);break;default:if(b&&a.match(/^[0-9]$/)&&(0===e||" "===c[e-1])){var o=c.slice(e).match(/^([0-9]+(?:\.[0-9]+)?)(ms|s|m) /);if(o){e+=o[0].length-1;var s=parseFloat(o[1]),n=void 0;switch(o[2]){case"ms":n=s;break;case"s":n=1e3*s;break;case"m":n=1e3*s*60}r(n/v.frameTimeFactor);break}}i=Notification_1.Notification.createNext(d(a)),r(1)}i&&h.push({frame:-1<m?m:p,notification:i}),p=t,l=e},v=this,o=0;o<e;o++)a(o),o=l;return h},c.prototype.run=function(e){var r=c.frameTimeFactor,t=this.maxFrames;c.frameTimeFactor=1,this.maxFrames=Number.POSITIVE_INFINITY,this.runMode=!0;var i={cold:(AsyncScheduler_1.AsyncScheduler.delegate=this).createColdObservable.bind(this),hot:this.createHotObservable.bind(this),flush:this.flush.bind(this),expectObservable:this.expectObservable.bind(this),expectSubscriptions:this.expectSubscriptions.bind(this)};try{var a=e(i);return this.flush(),a}finally{c.frameTimeFactor=r,this.maxFrames=t,this.runMode=!1,AsyncScheduler_1.AsyncScheduler.delegate=void 0}},c}(VirtualTimeScheduler_1.VirtualTimeScheduler);exports.TestScheduler=TestScheduler;